#!/bin/bash
# dotsync: export installed packages into ~/.dotfiles/README.md

set -e

DOTFILES="$HOME/.dotfiles"
README="$DOTFILES/README.md"

# Collect package lists
PACMAN=$(comm -23 <(pacman -Qeq | sort) <(pacman -Qmq | sort))
YAY=$(yay -Qem | awk '{print $1}' | grep -Ev -- '(-debug$|^yay$)' | sort)
FLATPAK=$(flatpak list --app --columns=application | sort)

# Replace sections inside README.md
awk -v pacman="$PACMAN" -v yay="$YAY" -v flatpak="$FLATPAK" '
BEGIN { in_block=0 }
{
  if ($0 ~ /<!-- START PACKAGES -->/) {
    print $0
    print ""
    print "### Pacman packages"
    print "```"
    print pacman
    print "```"
    print ""
    print "### Yay (AUR) packages"
    print "```"
    print yay
    print "```"
    print ""
    print "### Flatpak packages"
    print "```"
    print flatpak
    print "```"
    in_block=1
  }
  else if ($0 ~ /<!-- END PACKAGES -->/) {
    in_block=0
    print $0
  }
  else if (!in_block) {
    print $0
  }
}' "$README" > "$README.tmp" && mv "$README.tmp" "$README"

echo "Updated package list in $README"

cd "$DOTFILES"
git add .
git commit -m "chore(dotsync): update package list on $(date +'%Y-%m-%d %H:%M:%S')" || {
    echo "Nothing to commit."
  exit 0
}
git push
echo "Changes pushed to remote"
